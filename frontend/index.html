<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HELLO WORD</title>
    <style>
        #linksContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .card {
            width: 300px;
        }
        .card img {
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>HOLA</h1>
    <p>Estado: <span id="estado">desconectado</span></p>
    <p>Última actualización: <span id="lastUpdate">-</span></p>
    <p>Conteo actual: <span id="contador">-</span></p>
    <div id="linksContainer"></div>
    <script>
        const estadoEl = document.getElementById('estado');
        const lastUpdateEl = document.getElementById('lastUpdate');
        const contadorElemento = document.getElementById('contador');
        const linksContainer = document.getElementById('linksContainer');

        const WS_URL = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
            ? `ws://${location.hostname}:8080/ws`
            : `wss://${location.host}/ws`;

        let socket;
        let retryMs = 500;

        function connect() {
            socket = new WebSocket(WS_URL);
            socket.onopen = () => {
                estadoEl.textContent = 'conectado';
                retryMs = 500;
            };
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                contadorElemento.textContent = data.total_count ?? '-';
                lastUpdateEl.textContent = data.last_update ?? '-';
                if (data.op === 'insert' && data.url && data.id) {
                    addCard({ id: data.id, url: data.url });
                } else if (data.op === 'delete' && data.id) {
                    removeCard(data.id);
                }
            };
            socket.onclose = () => {
                estadoEl.textContent = 'reconectando...';
                setTimeout(connect, Math.min(retryMs *= 2, 5000));
            };
        }
        connect();

        async function addCard(link) {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.id = link.id;

            const img = document.createElement('img');
            try {
                const res = await fetch(`/preview?u=${encodeURIComponent(link.url)}`);
                if (!res.ok) throw new Error();
                img.src = await res.text();
            } catch {
                img.src = `https://www.google.com/s2/favicons?sz=128&domain_url=${encodeURIComponent(link.url)}`;
            }
            img.alt = link.url;

            const a = document.createElement('a');
            a.href = link.url;
            a.textContent = link.url;

            card.appendChild(img);
            card.appendChild(a);
            linksContainer.appendChild(card);
        }

        function removeCard(id) {
            const card = linksContainer.querySelector(`[data-id='${id}']`);
            if (card) card.remove();
        }

        fetch('/links')
            .then(r => r.json())
            .then(links => links.forEach(link => addCard(link)));
    </script>
</body>
</html>
